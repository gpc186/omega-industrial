<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OmegaPetro - Cadastro</title>
    <link rel="icon" href="../assets/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../style/criar-conta.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.1.1/css/intlTelInput.css" />

</head>

<body>
    <!-- Header -->

    <header>
        <nav>
            <div class="nav-content">
                <div class="nav-img">
                    <a href="/index">
                        <img class="nav-img-logo" src="../assets/img/logo.png" alt="OmegaPetro Logo">
                    </a>
                </div>
                <div class="nav-navegacao" id="navMenu"></div>
            </div>
            <div class="nav-content" style="justify-content: end;">
                <div class="nav-login"></div>
                <div class="hamburger" id="hamburger"></div>
            </div>
        </nav>
    </header>

    <!-- Header -->

    <main>
        <div class="caixa">
            <div class="form-card">
                <h1 class="titulo">Dados de Acesso</h1>
                <p class="subtitulo">Preencha todos os campos obrigatórios para criar sua conta</p>
                <form id="form-cadastro">
                    <div class="linha">
                        <div class="grupo-formulario">
                            <label>Empresa</label>
                            <input type="text" name="nome" placeholder="Nome da empresa" required />
                        </div>
                        <div class="grupo-formulario">
                            <label>CNPJ</label>
                            <input type="text" id="cnpj" placeholder="00.000.000/0000-00" maxlength="18" required />
                        </div>
                    </div>
                    <div class="linha">
                        <div class="grupo-formulario">
                            <label>Email</label>
                            <input type="email" id="email" placeholder="seu@email.com" required />
                        </div>
                        <div class="grupo-formulario">
                            <label>Telefone</label>
                            <input id="telefone" type="tel" required />
                        </div>
                    </div>
                    <div class="linha">
                        <div class="grupo-formulario">
                            <label>Senha</label>
                            <div class="senha">
                                <input type="password" id="senha1" placeholder="Digite sua senha" required />
                                <button type="button" class="button-imagem" onclick="toggleSenha('senha1','eyeIcon1')">
                                    <div class="eye-icon eye-closed" id="eyeIcon1">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle class="eye-pupil" cx="12" cy="12" r="3"></circle>
                                            <line class="eye-slash" x1="3" y1="3" x2="21" y2="21"></line>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>
                        <div class="grupo-formulario">
                            <label>Confirmar Senha</label>
                            <div class="senha">
                                <input type="password" id="senha2" placeholder="Confirme sua senha" required />
                                <button type="button" class="button-imagem" onclick="toggleSenha('senha2','eyeIcon2')">
                                    <div class="eye-icon eye-closed" id="eyeIcon2">
                                        <svg viewBox="0 0 24 24">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle class="eye-pupil" cx="12" cy="12" r="3"></circle>
                                            <line class="eye-slash" x1="3" y1="3" x2="21" y2="21"></line>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="enviar-btn">ENVIAR</button>
                </form>
                <div class="divisao">ou</div>
                <div class="criar-conta">
                    <p class="criar-conta-texto">Já possui conta?</p>
                    <a href="/login" class="criar-conta-link">LOGIN</a>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.1.1/js/intlTelInput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/google-libphonenumber/3.2.31/libphonenumber.js"></script>


    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const loginLink = document.getElementById('loginLink');
        const dashboardLink = document.getElementById('dashboardLink');
        const navLoginContainer = document.querySelector('.nav-btn-container');

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        if (token && user.nome) {
            loginLink.style.display = "none";
            navLoginContainer.innerHTML = `<button class="nav-btn-entrar" onclick="logout()">Sair</button>`;
            if (user.role === "admin" || user.role === "adm") {
                dashboardLink.style.display = "block";
            }
        } else {
            dashboardLink.style.display = "none";
        }

        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');

        hamburger.addEventListener('click', (e) => {
            e.stopPropagation(); // ⚡ Impede que o clique se propague
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        // Fecha o menu quando clicar fora
        document.addEventListener('click', (e) => {
            if (!navMenu.contains(e.target) && !hamburger.contains(e.target)) {
                navMenu.classList.remove('active');
                hamburger.classList.remove('active');
            }
        });

        // Impede seleção de texto acidental
        document.body.style.userSelect = "none";
        navMenu.style.userSelect = "auto"; // Só permite selecio
    </script>



    <script>
        // =========================
        //  TOGGLE SENHA
        // =========================
        function toggleSenha(inputId, eyeId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(eyeId);

            if (input.type === "password") {
                input.type = "text";
                eye.classList.replace("eye-closed", "eye-open");
            } else {
                input.type = "password";
                eye.classList.replace("eye-open", "eye-closed");
            }
        }

        // =========================
        //  VALIDAÇÃO DE EMAIL
        // =========================
        document.getElementById("email").addEventListener("input", (e) => {
            // sem borda verde/vermelha
        });

        // =========================
        //  MÁSCARA DE CNPJ
        // =========================
        document.getElementById("cnpj").addEventListener("input", (e) => {
            let v = e.target.value.replace(/\D/g, "");
            v = v.replace(/(\d{2})(\d)/, "$1.$2");
            v = v.replace(/(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4");
            v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, "$1.$2.$3/$4-$5");
            e.target.value = v;
        });

        // =========================
        //  REMOVIDO: VERIFICAÇÃO DE CNPJ REAL
        // =========================

        // =========================
        //  TELEFONE INTERNACIONAL
        //  (SEM BORDAS VERDES/VERMELHAS)
        // =========================

        let iti;

        (function () {
            const input = document.getElementById("telefone");
            if (!input) return;

            iti = intlTelInput(input, {
                initialCountry: "br",
                separateDialCode: true,
                nationalMode: true,
                autoInsertDialCode: true,
                autoPlaceholder: "aggressive",
                formatOnDisplay: false,
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/18.1.1/js/utils.js"
            });

            const phoneUtil = libphonenumber.PhoneNumberUtil.getInstance();
            const AsYouType = libphonenumber.AsYouTypeFormatter;
            const PNF = libphonenumber.PhoneNumberFormat;

            function getMaxDigits(countryIso) {
                try {
                    if (countryIso === "BR") return 11;
                    const exMobile = phoneUtil.getExampleNumberForType(countryIso, libphonenumber.PhoneNumberType.MOBILE);
                    const ex = exMobile || phoneUtil.getExampleNumber(countryIso);
                    if (!ex) return 15;
                    const formatted = phoneUtil.format(ex, PNF.NATIONAL);
                    return formatted.replace(/\D/g, "").length;
                } catch {
                    return 15;
                }
            }

            function formatUsingAsYouType(digits, countryIso) {
                const max = getMaxDigits(countryIso);
                if (digits.length > max) digits = digits.slice(0, max);

                try {
                    const fmt = new AsYouType(countryIso);
                    let out = "";
                    for (const d of digits) out = fmt.inputDigit(d);
                    return out;
                } catch {
                    return digits.replace(/(\d{3})(?=\d)/g, "$1 ");
                }
            }

            function formatBR(digits) {
                if (digits.length > 11) digits = digits.slice(0, 11);

                if (digits.length >= 3 && digits[2] !== "9") {
                    digits = digits.slice(0, 2) + "9" + digits.slice(2);
                    if (digits.length > 11) digits = digits.slice(0, 11);
                }

                if (digits.length <= 2) return digits;
                if (digits.length <= 6) return digits.replace(/^(\d{2})(\d+)/, "($1) $2");
                if (digits.length <= 10) return digits.replace(/^(\d{2})(\d{4})(\d+)/, "($1) $2-$3");

                return digits.replace(/^(\d{2})(\d{5})(\d{4}).*/, "($1) $2-$3");
            }

            let currentCountry = iti.getSelectedCountryData().iso2.toUpperCase();

            input.addEventListener("keydown", (e) => {
                const allowed = ["Backspace", "Delete", "ArrowLeft", "ArrowRight", "Home", "End", "Tab"];
                if (allowed.includes(e.key)) return;
                if (e.ctrlKey || e.metaKey) return;
                if (!/[0-9]/.test(e.key)) e.preventDefault();
            });

            input.addEventListener("paste", (ev) => {
                ev.preventDefault();
                const txt = (ev.clipboardData || window.clipboardData).getData('text') || '';
                const digits = txt.replace(/\D/g, '');
                handleAndSet(digits);
            });

            input.addEventListener("countrychange", () => {
                currentCountry = iti.getSelectedCountryData().iso2.toUpperCase();
                const digits = input.value.replace(/\D/g, "");
                handleAndSet(digits);
            });

            function handleAndSet(raw) {
                let digits = raw.replace(/\D/g, "");
                const country = currentCountry;

                if (country === "BR") {
                    input.value = formatBR(digits);
                    return;
                }

                input.value = formatUsingAsYouType(digits, country);
            }

            input.addEventListener("input", () => {
                handleAndSet(input.value);
            });

            handleAndSet(input.value || "");

        })();

        // =========================
        // SENHA + CONFIRMAR (SEM BORDAS)
        // =========================
        const s1 = document.getElementById("senha1");
        const s2 = document.getElementById("senha2");

        function validarSenhas() {
            return s1.value.length >= 6 && s1.value === s2.value;
        }

        s1.addEventListener("input", validarSenhas);
        s2.addEventListener("input", validarSenhas);

        // =========================
        //  VALIDAÇÃO FINAL NO SUBMIT
        // =========================
        document.getElementById("form-cadastro").addEventListener("submit", function (e) {

            const cnpj = document.getElementById("cnpj").value;
            const email = document.getElementById("email").value;
            const senha1 = document.getElementById("senha1").value;
            const senha2 = document.getElementById("senha2").value;
            const telefone = document.getElementById("telefone").value.replace(/\D/g, "");

            let erro = false;
            let msg = "";

            if (cnpj.replace(/\D/g, "").length < 14) {
                erro = true;
                msg = "CNPJ incompleto.";
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                erro = true;
                msg = "Email inválido.";
            } // VALIDAÇÃO REAL DO TELEFONE PELA LIBPHONENUMBER
            const phoneInput = document.getElementById("telefone");
            const pais = iti.getSelectedCountryData().iso2.toUpperCase();
            const phoneUtil = libphonenumber.PhoneNumberUtil.getInstance();

            const digits = telefone.replace(/\D/g, "");
            const max = getMaxDigits(pais);

            if (digits.length !== max) {
                erro = true;
                msg = `O número para ${pais} deve ter ${max} dígitos. Você digitou ${digits.length}.`;
            }


            // OUTRAS VALIDAÇÕES AQUI ⬇️
            if (!erro && senha1 !== senha2) {
                erro = true;
                msg = "As senhas não coincidem.";
            } else if (!erro && senha1.length < 6) {
                erro = true;
                msg = "A senha deve ter pelo menos 6 caracteres.";
            }


            if (erro) {
                e.preventDefault();
                alert(msg);
            }
        });
    </script>
    <script>
        // Configuração da API
        const API_URL = 'http://localhost:4000/api';

        // Capturar o formulário
        document.getElementById('form-cadastro').addEventListener('submit', async function (e) {
            e.preventDefault();

            // Pegar os valores dos campos
            const nome = document.querySelector('input[placeholder="Nome da empresa"]').value;
            const CNPJ = document.getElementById('cnpj').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('telefone').value;
            const senha1 = document.getElementById('senha1').value;
            const senha2 = document.getElementById('senha2').value;

            // Validações básicas
            if (!nome || !CNPJ || !email || !phone || !senha1 || !senha2) {
                mostrarAlerta('Preencha todos os campos!', 'erro');
                return;
            }

            if (senha1 !== senha2) {
                mostrarAlerta('As senhas não coincidem!', 'erro');
                return;
            }

            if (senha1.length < 6) {
                mostrarAlerta('A senha deve ter pelo menos 6 caracteres!', 'erro');
                return;
            }

            // Limpar CNPJ (remover pontos, traços, barras)
            const cnpjLimpo = CNPJ.replace(/[^\d]/g, '');
            if (cnpjLimpo.length !== 14) {
                mostrarAlerta('CNPJ inválido! Deve ter 14 dígitos.', 'erro');
                return;
            }

            // Limpar telefone (remover parênteses, espaços, traços)
            const phoneLimpo = phone.replace(/[^\d]/g, '');

            // Desabilitar botão durante o envio
            const btnEnviar = document.querySelector('.enviar-btn');
            const textoOriginal = btnEnviar.textContent;
            btnEnviar.disabled = true;
            btnEnviar.textContent = 'Cadastrando...';

            try {
                // Fazer requisição para a API
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nome,
                        email: email,
                        CNPJ: cnpjLimpo,
                        phone: phoneLimpo,
                        password: senha1
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Sucesso! Salvar token e redirecionar
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    mostrarAlerta('Cadastro realizado com sucesso! Redirecionando...', 'sucesso');

                    // Redirecionar após 1.5 segundos
                    setTimeout(() => {
                        window.location.href = '/produtos';
                    }, 1500);
                } else {
                    // Erro retornado pela API
                    mostrarAlerta(data.error || 'Erro ao cadastrar. Tente novamente.', 'erro');
                    btnEnviar.disabled = false;
                    btnEnviar.textContent = textoOriginal;
                }

            } catch (error) {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao conectar com o servidor. Verifique se a API está rodando.', 'erro');
                btnEnviar.disabled = false;
                btnEnviar.textContent = textoOriginal;
            }
        });

        // Função para mostrar alertas
        function mostrarAlerta(mensagem, tipo) {
            // Remover alerta anterior se existir
            const alertaAntigo = document.getElementById('alerta-custom');
            if (alertaAntigo) {
                alertaAntigo.remove();
            }

            // Criar novo alerta
            const alerta = document.createElement('div');
            alerta.id = 'alerta-custom';
            alerta.className = tipo === 'sucesso' ? 'alerta-sucesso' : 'alerta-erro';
            alerta.textContent = mensagem;

            document.body.appendChild(alerta);

            // Mostrar com animação
            setTimeout(() => {
                alerta.classList.add('show');
            }, 10);

            // Remover após 4 segundos
            setTimeout(() => {
                alerta.classList.remove('show');
                setTimeout(() => alerta.remove(), 300);
            }, 4000);
        }
    </script>




</body>

</html>