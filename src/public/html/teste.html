<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaPetro - Relat√≥rios</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-weight: 600;
            color: #333;
        }

        .filters select, .filters input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filters select:focus, .filters input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .filters button:hover {
            background: #5568d3;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .card.primary .value { color: #667eea; }
        .card.success .value { color: #10b981; }
        .card.warning .value { color: #f59e0b; }
        .card.danger .value { color: #ef4444; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Relat√≥rios e An√°lises</h1>
            <p>Acompanhe suas vendas e estoque em tempo real</p>
        </header>

        <!-- Filtros -->
        <div class="filters">
            <div>
                <label>Ano:</label>
                <select id="yearFilter">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            <div>
                <label>M√™s:</label>
                <select id="monthFilter">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Mar√ßo</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11" selected>Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
            </div>
            <button onclick="loadReports()">üîÑ Atualizar</button>
        </div>

        <!-- Cards de Resumo -->
        <div class="cards" id="summaryCards">
            <div class="card primary">
                <h3>Total de Vendas</h3>
                <div class="value" id="totalVendas">R$ 0,00</div>
            </div>
            <div class="card success">
                <h3>Total de Pedidos</h3>
                <div class="value" id="totalPedidos">0</div>
            </div>
            <div class="card warning">
                <h3>Ticket M√©dio</h3>
                <div class="value" id="ticketMedio">R$ 0,00</div>
            </div>
            <div class="card danger">
                <h3>Produtos em Falta</h3>
                <div class="value" id="produtosFalta">0</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <!-- Vendas Di√°rias -->
            <div class="chart-container full-width">
                <h2>üìà Vendas Di√°rias do M√™s</h2>
                <canvas id="salesChart"></canvas>
            </div>

            <!-- Vendas por Categoria -->
            <div class="chart-container">
                <h2>üéØ Vendas por Categoria</h2>
                <canvas id="categoryChart"></canvas>
            </div>

            <!-- Status dos Pedidos -->
            <div class="chart-container">
                <h2>üì¶ Status dos Pedidos</h2>
                <canvas id="statusChart"></canvas>
            </div>

            <!-- Produtos Mais Vendidos -->
            <div class="chart-container full-width">
                <h2>üèÜ Top 10 Produtos Mais Vendidos</h2>
                <canvas id="topProductsChart"></canvas>
            </div>

            <!-- Estoque por Categoria -->
            <div class="chart-container">
                <h2>üì¶ Estoque por Categoria</h2>
                <canvas id="stockChart"></canvas>
            </div>

            <!-- Valor do Estoque -->
            <div class="chart-container">
                <h2>üí∞ Valor do Estoque</h2>
                <canvas id="stockValueChart"></canvas>
            </div>
        </div>

        <!-- Tabela de Produtos com Estoque Baixo -->
        <div class="table-container">
            <h2>‚ö†Ô∏è Produtos com Estoque Baixo</h2>
            <table id="lowStockTable">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Categoria</th>
                        <th>Estoque Atual</th>
                        <th>Pre√ßo</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="loading">Carregando...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Tabela de Melhores Clientes -->
        <div class="table-container" style="margin-top: 30px;">
            <h2>üë• Top 10 Melhores Clientes do M√™s</h2>
            <table id="topCustomersTable">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>CNPJ</th>
                        <th>Total de Pedidos</th>
                        <th>Total Gasto</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Configura√ß√£o da API
        const API_URL = 'http://localhost:3000/api';
        const token = localStorage.getItem('token'); // Pegue o token do localStorage

        // Headers para requisi√ß√µes
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };

        // Vari√°veis dos gr√°ficos
        let salesChart, categoryChart, statusChart, topProductsChart, stockChart, stockValueChart;

        // Fun√ß√£o para formatar moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        // Fun√ß√£o para formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Carregar relat√≥rios
        async function loadReports() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;

            try {
                // Carregar todos os dados em paralelo
                const [
                    salesSummary,
                    salesByDay,
                    topProducts,
                    salesByCategory,
                    topCustomers,
                    lowStock,
                    outOfStock,
                    stockByCategory
                ] = await Promise.all([
                    fetch(`${API_URL}/reports/sales/summary?year=${year}&month=${month}`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/sales/monthly?year=${year}&month=${month}`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/sales/top-products?year=${year}&month=${month}&limit=10`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/sales/by-category?year=${year}&month=${month}`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/sales/top-customers?year=${year}&month=${month}&limit=10`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/stock/low?threshold=10`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/stock/out`, { headers }).then(r => r.json()),
                    fetch(`${API_URL}/reports/stock/by-category`, { headers }).then(r => r.json())
                ]);

                // Atualizar cards de resumo
                updateSummaryCards(salesSummary, outOfStock.length);

                // Atualizar gr√°ficos
                updateSalesChart(salesByDay.detalhes || salesByDay);
                updateCategoryChart(salesByCategory);
                updateStatusChart(salesSummary);
                updateTopProductsChart(topProducts);
                updateStockChart(stockByCategory);
                updateStockValueChart(stockByCategory);

                // Atualizar tabelas
                updateLowStockTable(lowStock);
                updateTopCustomersTable(topCustomers);

            } catch (error) {
                console.error('Erro ao carregar relat√≥rios:', error);
                alert('Erro ao carregar relat√≥rios. Verifique sua conex√£o.');
            }
        }

        // Atualizar cards de resumo
        function updateSummaryCards(summary, outOfStockCount) {
            document.getElementById('totalVendas').textContent = formatCurrency(summary.total_vendas);
            document.getElementById('totalPedidos').textContent = summary.total_pedidos || 0;
            document.getElementById('ticketMedio').textContent = formatCurrency(summary.ticket_medio);
            document.getElementById('produtosFalta').textContent = outOfStockCount;
        }

        // Gr√°fico de Vendas Di√°rias
        function updateSalesChart(data) {
            const ctx = document.getElementById('salesChart');
            
            if (salesChart) salesChart.destroy();

            const groupedData = {};
            data.forEach(item => {
                const date = formatDate(item.data);
                if (!groupedData[date]) {
                    groupedData[date] = 0;
                }
                groupedData[date] += parseFloat(item.total_vendas || 0);
            });

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(groupedData),
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: Object.values(groupedData),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Vendas: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de Vendas por Categoria
        function updateCategoryChart(data) {
            const ctx = document.getElementById('categoryChart');
            
            if (categoryChart) categoryChart.destroy();

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.categoria),
                    datasets: [{
                        data: data.map(item => item.receita_total),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de Status dos Pedidos
        function updateStatusChart(data) {
            const ctx = document.getElementById('statusChart');
            
            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pendente', 'Conclu√≠do', 'Cancelado'],
                    datasets: [{
                        data: [
                            data.pendentes || 0,
                            data.concluidos || 0,
                            data.cancelados || 0
                        ],
                        backgroundColor: ['#f59e0b', '#10b981', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Gr√°fico de Top Produtos
        function updateTopProductsChart(data) {
            const ctx = document.getElementById('topProductsChart');
            
            if (topProductsChart) topProductsChart.destroy();

            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.nome),
                    datasets: [{
                        label: 'Quantidade Vendida',
                        data: data.map(item => item.total_vendido),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        // Gr√°fico de Estoque por Categoria
        function updateStockChart(data) {
            const ctx = document.getElementById('stockChart');
            
            if (stockChart) stockChart.destroy();

            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.categoria),
                    datasets: [{
                        label: 'Estoque Total',
                        data: data.map(item => item.estoque_total),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Gr√°fico de Valor do Estoque
        function updateStockValueChart(data) {
            const ctx = document.getElementById('stockValueChart');
            
            if (stockValueChart) stockValueChart.destroy();

            stockValueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.categoria),
                    datasets: [{
                        data: data.map(item => item.valor_total),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar tabela de estoque baixo
        function updateLowStockTable(data) {
            const tbody = document.querySelector('#lowStockTable tbody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#10b981;">‚úÖ Nenhum produto com estoque baixo!</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.nome}</td>
                    <td>${item.categoria}</td>
                    <td style="color: ${item.estoque_atual === 0 ? '#ef4444' : '#f59e0b'}; font-weight: 600;">
                        ${item.estoque_atual}
                    </td>
                    <td>${formatCurrency(item.preco)}</td>
                    <td>${formatCurrency(item.preco * item.estoque_atual)}</td>
                </tr>
            `).join('');
        }

        // Atualizar tabela de melhores clientes
        function updateTopCustomersTable(data) {
            const tbody = document.querySelector('#topCustomersTable tbody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum cliente encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((item, index) => `
                <tr>
                    <td>${index + 1}. ${item.nome}</td>
                    <td>${item.CNPJ}</td>
                    <td>${item.total_pedidos}</td>
                    <td style="color: #10b981; font-weight: 600;">${formatCurrency(item.total_gasto)}</td>
                </tr>
            `).join('');
        }

        // Carregar relat√≥rios ao iniciar
        window.addEventListener('DOMContentLoaded', () => {
            loadReports();
        });
    </script>
</body>
</html>