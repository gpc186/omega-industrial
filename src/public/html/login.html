<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petro - Login</title>
    <link rel="stylesheet" href="../style/login.css">
</head>

<body>
    <!-- ====================== HEADER NOVO ======================= -->

    <header class="op-header">
        <nav class="op-nav">
            <div class="op-container">

                <a href="index.html" class="op-logo">
                    <img src="../assets/img/logo.png" alt="OmegaPetro Logo">
                </a>

                <div class="op-menu" id="navMenu">

                    <a href="produtos.html">Produtos</a>
                    <a href="admIndex.html" id="dashboardLink" style="display:none;">Dashboard</a>
                    <a href="carrinho.html">Carrinho</a>

                    <div class="op-login nav-btn-container">
                        <a href="login.html" id="loginLink">
                            <img src="../assets/img/login.png" alt="">
                        </a>
                    </div>

                </div>

                <button class="op-hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>

            </div>
        </nav>
    </header>

    <div class="caixa">
        <div class="login-card">
            <h1 class="titulo">Bem-Vindo</h1>
            <p class="subtitulo">Por favor, insira seus dados para fazer login</p>

            <form id="formulario-login">
                <div class="grupo-formulario">
                    <label for="email">Endereço de Email</label>
                    <input type="email" id="email" name="email" placeholder="seu@email.com" required>
                </div>

                <div class="grupo-formulario">
                    <label for="senha">Senha</label>
                    <div class="senha">
                        <input type="password" id="senha" name="senha" placeholder="Digite sua senha" required>
                        <button type="button" class="button-imagem" onclick="toggleSenha()">
                            <div class="eye-icon eye-closed" id="eyeIcon">
                                <svg viewBox="0 0 24 24">
                                    <!-- Contorno do olho -->
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <!-- Pupila -->
                                    <circle class="eye-pupil" cx="12" cy="12" r="3"></circle>
                                    <!-- Linha que corta o olho (slash) -->
                                    <line class="eye-slash" x1="3" y1="3" x2="21" y2="21"></line>
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
                <div id="mensagem-erro" class="mensagem-erro">
                </div>

                <button type="submit" class="login-btn">Entrar</button>
            </form>


            <div class="divisao">ou</div>
            <div class="criar-conta">
                <p class="criar-conta-texto">Novo por aqui?</p>
                <a href="criar-conta.html" class="criar-conta-link">CRIAR CONTA</a>
            </div>
        </div>
    </div>

    <script>
          const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const loginLink = document.getElementById('loginLink');
        const dashboardLink = document.getElementById('dashboardLink');
        const navLoginContainer = document.querySelector('.nav-btn-container');

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        if (token && user.nome) {
            loginLink.style.display = "none";
            navLoginContainer.innerHTML = `<button class="nav-btn-entrar" onclick="logout()">Sair</button>`;
            if (user.role === "admin" || user.role === "adm") {
                dashboardLink.style.display = "block";
            }
        } else {
            dashboardLink.style.display = "none";
        }

            const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');

        hamburger.addEventListener('click', (e) => {
            e.stopPropagation(); // ⚡ Impede que o clique se propague
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        // Fecha o menu quando clicar fora
        document.addEventListener('click', (e) => {
            if (!navMenu.contains(e.target) && !hamburger.contains(e.target)) {
                navMenu.classList.remove('active');
                hamburger.classList.remove('active');
            }
        });

        // Impede seleção de texto acidental
        document.body.style.userSelect = "none";
        navMenu.style.userSelect = "auto"; // Só permite selecio
    </script>

    <script>
        function toggleSenha() {
            const input = document.getElementById('senha');
            const eyeIcon = document.getElementById('eyeIcon');

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.classList.remove('eye-closed');
                eyeIcon.classList.add('eye-open');
            } else {
                input.type = 'password';
                eyeIcon.classList.remove('eye-open');
                eyeIcon.classList.add('eye-closed');
            }
        }

        document.getElementById('formulario-login').addEventListener('submit', function (e) {
            e.preventDefault();

            const senha = document.getElementById('senha').value;
            const customAlert = document.getElementById('custom-alert');

            const regexSenha = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;

            // MOSTRA MENSAGEM DE SUCESSO
            customAlert.textContent = "Login realizado com sucesso!";
            customAlert.classList.remove('error');
            customAlert.classList.add('show', 'success');

            // Some sozinho depois de 1.8s (opcional)
            setTimeout(() => {
                customAlert.classList.remove('show');
            }, 1800);
        });
    </script>
     <script>
        const API_URL = 'http://localhost:3000/api';

        document.getElementById('formulario-login').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;

            if (!email || !senha) {
                mostrarAlerta('Preencha todos os campos!', 'erro');
                return;
            }

            // Desabilitar botão
            const btnLogin = document.querySelector('.login-btn');
            const textoOriginal = btnLogin.textContent;
            btnLogin.disabled = true;
            btnLogin.textContent = 'Entrando...';

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: senha
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Salvar token e dados do usuário
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    mostrarAlerta('Login realizado com sucesso!', 'sucesso');
                    
                    // Redirecionar baseado no role
                    setTimeout(() => {
                        if (data.user.role === 'adm') {
                            window.location.href = 'admIndex.html';
                        } else {
                            window.location.href = 'produtos.html';
                        }
                    }, 1000);
                } else {
                    mostrarAlerta(data.error || 'Email ou senha incorretos!', 'erro');
                    btnLogin.disabled = false;
                    btnLogin.textContent = textoOriginal;
                }

            } catch (error) {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao conectar com o servidor!', 'erro');
                btnLogin.disabled = false;
                btnLogin.textContent = textoOriginal;
            }
        });

        function mostrarAlerta(mensagem, tipo) {
            const alertaAntigo = document.getElementById('alerta-custom');
            if (alertaAntigo) alertaAntigo.remove();

            const alerta = document.createElement('div');
            alerta.id = 'alerta-custom';
            alerta.className = tipo === 'sucesso' ? 'alerta-sucesso' : 'alerta-erro';
            alerta.textContent = mensagem;
            
            document.body.appendChild(alerta);
            setTimeout(() => alerta.classList.add('show'), 10);
            setTimeout(() => {
                alerta.classList.remove('show');
                setTimeout(() => alerta.remove(), 300);
            }, 4000);
        }
    </script>
    <div id="custom-alert"></div>

</body>

</html>